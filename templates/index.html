<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Palatable</title>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="{{ url_for ('static', filename='index.css') }}">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <!-- Fontawesome -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    </head>

    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-primary fixed-top">
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <!-- Navbar items -->
          <div class="collapse navbar-collapse container" id="navbar">
              <ul class="nav navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="#"><i class="fab fa-github"></i> Github</a>
                </li>
              </ul>
              <ul class="nav navbar-nav mx-auto">
                <li class="nav-item active">
                  <a class="nav-link" href="#"><i class="fab fa-paypal"></i></a>
                </li>
              </ul>
              <ul class="nav navbar-nav">
                <li class="nav-item">
                  <a class="nav-link" href="#"><i class="fas fa-heart"></i> Donate</a>
                </li>
              </ul>
          </div>
        </nav>
        <!-- Content -->
        <div class="container">
            <div class="container" id="main">
                <div class="text-center"><h1>Palatable</h1></div>
                <form>
                  <div class="form-group">
                    <label for="url"><i class="fas fa-code"></i> Webpage URL</label>
                    <input class="form-control" id="url" name="url" aria-describedby="url" placeholder="Enter a valid URL">
                  </div>
                  <div class="form-group">
                    <label for="nColors"><i class="fas fa-palette"></i> Number of Colors</label>
                    <input class="form-control" id="nColors" name="nColors" aria-describedby="nColors" placeholder="Enter an integer number of colors">
                  </div>
                </form>
                <div class="text-center">
                  <button class="btn btn-primary" onClick="APICall()">
                    Submit <i class="fas fa-check-circle"></i>
                  </button>
              </div>
            </div>
            <div class="progress" id="load">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><span id="load-txt"></span></div>
            </div>
            <div class="container row" id="result"></div>
        </div>
    </body>

    <script>
        function APICall() {
            console.log("passing "+String($("#url").val())+" as 'url'");
            console.log("passing "+String($("#nColors").val())+" as 'nColors'");
            $.ajax({
                type: "POST",
                url: "/result",
                data: JSON.stringify({ "url": $("#url").val(), "nColors": $("#nColors").val() }),
                contentType: "application/json;charset=UTF-8",
                success: function(data, status, request) {
                    $("#main").hide();
                    $("#load").show();
                    statusURL = request.getResponseHeader("Location");
                    Update(statusURL);
                },
                error: function() {
                    alert("Unexpected error");
                    $("#load").hide();
                    $("#main").show();
                }
            });
        }
        function Update(statusURL) {
            var mainDiv = $("#main");
            var resultDiv = $("#result");
            var loadBar = $("#load");
            var loadTxt = $("#load-txt");
            $.getJSON(statusURL, function(data) {
                console.log(data);
                if (data.state === "SUCCESS" && data.hasOwnProperty("result")) {
                    resultDiv.html("");
                    var colors = Object.keys(data.result);
                    for (var i = 0; i < colors.length; i++) {
                        var color = colors[i];
                        var count = data.result[color];
                        resultDiv.append(`
                            <div class="col-md-4 d-flex align-items-stretch">
                              <div class="card" id="${'colorCard'+String(i)}" style="background-color: '${color}'; width: 100%; height: 100px;">
                                <div class="card-body" id="${'colorBody'+String(i)}">
                                  ${color}
                                </div>
                              </div>
                            </div>
                        `);
                        $(`#colorCard${i}`).css({ "background-color": color });
                    }
                    loadBar.hide();
                    resultDiv.show();
                }
                else if (data.state === "FAILURE") {
                    mainDiv.show();
                    resultDiv.hide();
                    loadBar.hide();
                }
                else {
                    if (data.hasOwnProperty("status")) {
                        loadTxt.html(data.status);
                    }
                    console.log(data);
                    setTimeout(function() {
                        Update(statusURL);
                    }, 500);
                }
            });
        }
        $(function() {
            $("#load").hide();
            $("#result").hide().html("");
        })
    </script>

</html>
