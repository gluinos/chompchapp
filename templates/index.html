<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Palatable</title>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    </head>

    <body>
        <div class="container">
            <h1>Palatable</h1>
            <div class="container" id="main">
                <form>
                  <div class="form-group">
                    <label for="url">Webpage URL</label>
                    <input class="form-control" id="url" name="url" aria-describedby="url" placeholder="Enter a valid URL">
                  </div>
                </form>
                <button class="btn btn-primary" onClick="APICall()">Submit</button>
            </div>
            <div class="container" id="result" hidden></div>
            <hr>
            <footer>
                <p>Jonathan Guiang</p>
            </footer>
        </div>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    </body>

    <script>
        function APICall() {
            var mainDiv = $("#main");
            var resultDiv = $("#result");
            console.log("passing "+String($("#url").val())+" as 'data'");
            $.ajax({
                type: 'POST',
                url: '/result',
                data: JSON.stringify({ "url": $("#url").val() }),
                contentType: 'application/json;charset=UTF-8',
                success: function(data, status, request) {
                    mainDiv.hide();
                    resultDiv.html(`<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div>`).show();
                    statusURL = request.getResponseHeader('Location');
                    Update(statusURL, mainDiv, resultDiv);
                },
                error: function() {
                    alert('Unexpected error');
                }
            });
        }
        function Update(statusURL, mainDiv, resultDiv) {
            $.getJSON(statusURL, function(data) {
                console.log(data);
                if (data.state === "SUCCESS" && data.hasOwnProperty("result")) {
                    resultDiv.html(data.result);
                }
                else if (data.state === "FAILURE") {
                    mainDiv.show();
                    resultDiv.hide();
                }
                else {
                    // rerun in 2 seconds
                    console.log(data);
                    setTimeout(function() {
                        Update(statusURL, mainDiv, resultDiv);
                    }, 1000);
                }
            });
        }
    </script>

</html>
